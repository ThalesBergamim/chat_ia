{% extends 'base.html' %}

{% block styles %}
<style>
    body, html {
        height: 100%;
        background-color: #f0f0f0;
    }

    .chat-container {
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .messages-box {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px;
        background-color: #e0e0e0;
        border-radius: 0 0 10px 10px;
    }

    .message {
        margin-bottom: 15px;
        list-style: none;
        display: flex;
        flex-direction: column;
        max-width: 75%;
        padding: 8px 12px;
        border-radius: 10px;
        animation: fadeIn 0.3s ease;
    }

    .sent {
        background-color: #d1d1d1;
        align-self: flex-end;
        text-align: right;
    }

    .received {
        background-color: #bdbdbd;
        align-self: flex-start;
    }

    .message-form {
        display: flex;
        padding: 10px;
        background-color: #e0e0e0;
        border-top: 1px solid #b0b0b0;
    }

    .message-input {
        flex: 1;
        border-radius: 5px;
        border: 1px solid #b0b0b0;
        padding: 10px;
        margin-right: 10px;
    }

    .btn-send {
        border-radius: 5px;
        background-color: #6c757d;
        border: none;
        color: white;
    }

    .btn-send:hover {
        background-color: #5a6268;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="card flex-grow-1">
        <div class="card-header text-white bg-secondary">ðŸ’¬ PyIA - Chatbot</div>
        <div class="card-body messages-box">

            <ul class="list-unstyled messages-list">

                {% for chat in chats %}
                    <li class="message sent">
                        <div><b>VocÃª:</b> {{ chat.message }}</div>
                    </li>
                    <li class="message received">
                        <div><b>AI Chatbot:</b> {{ chat.response|safe }}</div>
                    </li>
                {% endfor %}

            </ul>

        </div>
    </div>
    
    <!-- FormulÃ¡rio Movido para Dentro da Estrutura da PÃ¡gina -->
    <form class="message-form">
        {% csrf_token %}
        <input type="text" class="form-control message-input" placeholder="Digite sua mensagem..." required>
        <button type="submit" class="btn btn-send">Enviar</button>
    </form>
</div>

<script>
    const messagesList = document.querySelector('.messages-list');
    const messageForm = document.querySelector('.message-form');
    const messageInput = document.querySelector('.message-input');

    messageForm.addEventListener('submit', (event) => {
        event.preventDefault();

        const message = messageInput.value.trim();
        if (message.length === 0) return;

        // Exibindo mensagem do usuÃ¡rio imediatamente
        const userMessage = document.createElement('li');
        userMessage.classList.add('message', 'sent');
        userMessage.innerHTML = `<div><b>VocÃª:</b> ${message}</div>`;
        messagesList.appendChild(userMessage);
        messagesList.scrollTop = messagesList.scrollHeight;

        messageInput.value = '';

        // Enviando mensagem via AJAX
        fetch('', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'message': message
            })
        })
        .then(response => response.json())
        .then(data => {
            const responseMessage = document.createElement('li');
            responseMessage.classList.add('message', 'received');
            responseMessage.innerHTML = `<div><b>AI Chatbot:</b> ${data.response}</div>`;
            messagesList.appendChild(responseMessage);
            messagesList.scrollTop = messagesList.scrollHeight;
        });
    });
</script>
{% endblock %}
